{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Usuario</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>

    <!-- Figuras decorativas -->
    <div class="floating-shape shape-1">‚≠ê</div>
    <div class="floating-shape shape-2">üöÄ</div>
    <div class="floating-shape shape-3">üí°</div>
    <div class="floating-shape shape-4">‚ú®</div>

    <div class="profile-container">

        <!-- Bot√≥n atr√°s -->
        <a href="{% url 'home' %}" class="back-btn" style="
            padding: 10px 18px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;">
            ‚¨Ö Atr√°s
        </a>

        <!-- Mensajes de Django -->
        {% if messages %}
            {% for message in messages %}
                <p class="django-message {{ message.tags }}" style="display:block;">{{ message }}</p>
            {% endfor %}
        {% endif %}

        <!-- Avatar -->
        <div class="profile-header">
            <div class="avatar">
                <img id="profile-image"
                     src="{% if profile.profile_picture %}{{ profile.profile_picture.url }}{% else %}{% static 'images/default_user.svg' %}{% endif %}"
                     alt="Foto de perfil">
            </div>

            <div class="photo-actions" style="margin-top:12px; display:flex; gap:10px; justify-content:center;">
                <button type="button" class="edit-btn" id="btn-change-photo">
                    Cambiar Foto
                </button>
            </div>
        </div>


        <!-- ============================
             FORMULARIO DE INFORMACI√ìN
        ============================== -->
        <div class="user-info">
            <h2>Informaci√≥n del Usuario</h2>

            <form id="info-form"
                  action="{% url 'user' %}"
                  method="POST"
                  enctype="multipart/form-data">

                {% csrf_token %}
                <input type="hidden" name="form_type" value="profile_update">

                <div class="info-item">
                    <label for="username">Nombre de Usuario:</label>
                    <input type="text" id="username" name="username" value="{{ user.username }}" readonly required>
                    <p id="username-error" class="validation-error hidden"></p>
                </div>

                <div class="info-item">
                    <label for="full-name">Nombres y Apellidos:</label>
                    <input type="text" id="full-name" name="full-name"
                           value="{{ user.first_name }} {{ user.last_name }}"
                           readonly>
                    <p id="full-name-error" class="validation-error hidden"></p>
                </div>

                <div class="info-item">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" value="{{ user.email }}" readonly>
                    <p id="email-error" class="validation-error hidden"></p>
                </div>

                <!-- Input oculto para foto -->
                <input type="file" id="profile-input" name="profile_picture" accept="image/*" style="display:none;">

                <!-- Bot√≥n editar -->
                <button type="button" class="edit-info-btn">Editar Informaci√≥n</button>
            </form>
        </div>


        <!-- ============================
             FORMULARIO DE CONTRASE√ëA
        ============================== -->
        <div class="password-change">
            <h2>Cambiar Contrase√±a</h2>

            <form id="password-form" method="POST" action="{% url 'user' %}">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="password_change">

                <div class="info-item">
                    <label for="current-password">Contrase√±a Actual:</label>
                    <div class="password-wrapper" style="display:flex; gap:8px; align-items:center;">
                        <input type="password" id="current-password" name="current-password" required>
                        <button type="button" class="toggle-pass" data-target="current-password">üëÅÔ∏è</button>
                    </div>
                </div>

                <div class="info-item">
                    <label for="new-password">Nueva Contrase√±a:</label>
                    <div class="password-wrapper" style="display:flex; gap:8px; align-items:center;">
                        <input type="password" id="new-password" name="new-password" required>
                        <button type="button" class="toggle-pass" data-target="new-password">üëÅÔ∏è</button>
                    </div>
                </div>

                <div class="info-item">
                    <label for="confirm-password">Confirmar Contrase√±a:</label>
                    <div class="password-wrapper" style="display:flex; gap:8px; align-items:center;">
                        <input type="password" id="confirm-password" name="confirm-password" required>
                        <button type="button" class="toggle-pass" data-target="confirm-password">üëÅÔ∏è</button>
                    </div>
                </div>

                <button type="submit" class="change-password-btn">Guardar Nueva Contrase√±a</button>
            </form>

            <p id="message" class="hidden"></p>
        </div>

    </div>

    <!-- Script vinculado -->
    <script src="{% static 'js/user_script.js' %}"></script>

    <script>
        // Bot√≥n que abre el selector de imagen
        document.getElementById("btn-change-photo").addEventListener("click", () => {
            document.getElementById("profile-input").click();
        });

        // Previsualizaci√≥n inmediata de imagen
        document.getElementById("profile-input").addEventListener("change", function(){
            const img = document.getElementById("profile-image");
            const file = this.files[0];
            if(file){
                img.src = URL.createObjectURL(file);
            }
        });
    </script>

</body>
</html>
